{% extends "home/base.html" %}
{% block title %}Create Character – Stage 1{% endblock %}
{% block content %}

<h2 style="text-align:center;">Stage 1: Basic Character Creation</h2>
<p style="text-align:center;">
  Enter your character’s name, choose your race (and subrace if available) and background,
  provide a backstory, and adjust your ability scores using the point-buy system.
</p>

<form method="post" id="characterForm"
      style="max-width:900px; margin: 0 auto; border:1px solid #ddd; padding:20px; background:#fff;">
  {% csrf_token %}
  
  <!-- =========================
       Basic Info: Name + Race
  ========================== -->
  <div style="background:#f9f9f9; padding:15px; margin-bottom:20px; border:1px solid #ddd;">
    <label for="name" style="display:block; margin-top:10px;">Character Name:</label>
    <input type="text" name="name" id="name" required style="width:100%; padding:8px;">
    
    <label for="race" style="display:block; margin-top:10px;">Race:</label>
    <select name="race" id="race" required style="width:100%; padding:8px;">
      <option value="">-- Select a Race --</option>
      <option value="human">Human</option>
      <option value="dwarf">Dwarf</option>
      <option value="elf">Elf</option>
      <option value="gnome">Gnome</option>
      <option value="tiefling">Tiefling</option>
      <option value="half_elf">Half-Elf</option>
      <option value="lizardfolk">Lizardfolk</option>
      <option value="halfling">Halfling</option>
      <option value="half_orc">Half-Orc</option>
      <option value="tabaxi">Tabaxi</option>
      <option value="goliath">Goliath</option>
      <option value="goblin">Goblin</option>
      <option value="githyanki">Githyanki</option>
      <option value="warforged">Warforged</option>
      <option value="elf_nymph">Elf-Nymph</option>
      <option value="yuan_ti">Yuan-Ti</option>
      <option value="kitsune">Kitsune</option>
    </select>
    
    <!-- Subrace dropdown -->
    <div id="subrace-container" style="display:none; margin-top:10px;">
      <label for="subrace">Subrace:</label>
      <select name="subrace" id="subrace" style="width:100%; padding:8px;"></select>
    </div>
    
    <!-- Racial Bonus Allocation (customizable) -->
    <div id="racial-allocation-section" style="display:none; border:1px solid #ddd; padding:10px; background:#eef; margin-bottom:20px;">
      <h3>Allocate Your Racial Bonus Points</h3>
      <p>You have <span id="racial-points"></span> bonus point(s) to allocate among your abilities.</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px;">
        <label>Strength: <input type="number" id="racial-strength" value="0" min="0" style="width:50px;"></label>
        <label>Dexterity: <input type="number" id="racial-dexterity" value="0" min="0" style="width:50px;"></label>
        <label>Constitution: <input type="number" id="racial-constitution" value="0" min="0" style="width:50px;"></label>
        <label>Intelligence: <input type="number" id="racial-intelligence" value="0" min="0" style="width:50px;"></label>
        <label>Wisdom: <input type="number" id="racial-wisdom" value="0" min="0" style="width:50px;"></label>
        <label>Charisma: <input type="number" id="racial-charisma" value="0" min="0" style="width:50px;"></label>
      </div>
      <button type="button" onclick="applyRacialAllocation()" style="margin-top:10px;">Apply Racial Bonuses</button>
    </div>

    <!-- For "Fully Half-Elf" origin -->
    <div id="half-elf-origin-container" style="display:none; border:1px solid #ddd; padding:10px; background:#eef; margin-bottom:20px;">
      <h3>Choose Your Half-Elf Origin</h3>
      <p>Select one of the following: High Elf (+1 Int), Wood Elf (+1 Wis), or Dark Elf (+1 Str).</p>
      <select id="half-elf-origin" name="half_elf_origin" style="width:100%; padding:8px;">
        <option value="high">High Elf</option>
        <option value="wood">Wood Elf</option>
        <option value="dark">Dark Elf</option>
      </select>
    </div>
  </div><!-- end basic info container -->

  <!-- =========================
       Background Combination
  ========================== -->
  <div style="background:#eef; padding:15px; margin-bottom:20px; border:1px solid #ddd;">
    <h3>Choose Your Background Combination</h3>
    <p>Select which combination you would like:</p>
    <label>
      <input type="radio" name="bg_combo" value="0" checked> 1 Main Background (0 Side)
    </label>
    <label>
      <input type="radio" name="bg_combo" value="1"> 1 Main Background + 1 Side Background
    </label>
    <label>
      <input type="radio" name="bg_combo" value="2"> 1 Main Background + 2 Side Backgrounds
    </label>
  </div>

  <!-- =========================
       Main Background
  ========================== -->
  <div style="background:#eef; padding:15px; margin-bottom:20px; border:1px solid #ddd;">
    <h3>Main Background</h3>
    <label for="main_background">Choose Main Background:</label>
    <select name="main_background" id="main_background" style="width:100%; padding:8px;">
      <option value="">-- Select Main Background --</option>
      <option value="noble">Noble</option>
      <option value="commoner">Commoner</option>
      <option value="artisan">Artisan</option>
    </select>
  </div>

  <!-- =========================
       Side Backgrounds
  ========================== -->
  <div id="side_background_1_container" style="display:none; margin-top:10px; border:1px solid #ddd; background:#eef; padding:15px;">
    <label for="side_background_1">Side Background 1:</label>
    <select name="side_background_1" id="side_background_1" style="width:100%; padding:8px;">
      <option value="">-- Select Side Background --</option>
      <option value="noble">Noble</option>
      <option value="commoner">Commoner</option>
      <option value="artisan">Artisan</option>
    </select>
    <p>Choose Bonus Type for Side Background 1:</p>
    <label><input type="radio" name="side1_bonus_type" value="ability" checked> Ability Score (+1)</label>
    <label><input type="radio" name="side1_bonus_type" value="skill"> Skill Proficiency</label>
  </div>

  <div id="side_background_2_container" style="display:none; margin-top:10px; border:1px solid #ddd; background:#eef; padding:15px;">
    <label for="side_background_2">Side Background 2:</label>
    <select name="side_background_2" id="side_background_2" style="width:100%; padding:8px;">
      <option value="">-- Select Side Background --</option>
      <option value="noble">Noble</option>
      <option value="commoner">Commoner</option>
      <option value="artisan">Artisan</option>
    </select>
    <p>Choose Bonus Type for Side Background 2:</p>
    <label><input type="radio" name="side2_bonus_type" value="ability" checked> Ability Score (+1)</label>
    <label><input type="radio" name="side2_bonus_type" value="skill"> Skill Proficiency</label>
  </div>

  <!-- =========================
       Skill Proficiency Display
  ========================== -->
  <div style="background:#eef; padding:15px; margin-bottom:20px; border:1px solid #ddd;">
    <h3>Background Skill Proficiencies</h3>
    <p id="background-skill-display">No skill proficiencies allocated yet.</p>
  </div>

  <!-- Hidden field for final race value -->
  <input type="hidden" name="final_race" id="finalRace" value="">

  <!-- Hidden inputs for final ability scores -->
  <input type="hidden" name="strength" id="strengthInput" value="8">
  <input type="hidden" name="dexterity" id="dexterityInput" value="8">
  <input type="hidden" name="constitution" id="constitutionInput" value="8">
  <input type="hidden" name="intelligence" id="intelligenceInput" value="8">
  <input type="hidden" name="wisdom" id="wisdomInput" value="8">
  <input type="hidden" name="charisma" id="charismaInput" value="8">

  <!-- =========================
       LOR Character Stats Table
  ========================== -->
  <div class="container" style="border:1px solid #ddd; padding:15px; background:#f9f9f9; margin-bottom:20px;">
    <h2 style="margin-top:0;">LOR Character Stats Calculator</h2>
    <div id="score-section">
      <h3>Add in Order: Point Buy &gt; Race &gt; Background &gt; Boost</h3>
      <p><strong>Point Buy Remaining:</strong> <span id="points-remaining">12</span></p>

      <p>
        <strong>Background Modifier Total:</strong>
        <span id="background-total">0</span> / 3
        <button type="button" onclick="resetBackground()">Reset Background</button>
      </p>
      <p>
        <strong>Boost Slots Remaining:</strong>
        <span id="boosts-remaining">5</span>
        <button type="button" onclick="resetBoosts()">Reset Boosts</button>
      </p>
      
      <h3>Adjust Base Scores (Point Buy)</h3>
      <table style="width:100%; border-collapse:collapse; margin-top:10px;">
        <thead>
          <tr style="background:#eee;">
            <th style="padding:8px; border:1px solid #ccc;">Ability</th>
            <th style="padding:8px; border:1px solid #ccc;">Base Score (8–13)</th>
            <th style="padding:8px; border:1px solid #ccc;">Race Mod</th>
            <th style="padding:8px; border:1px solid #ccc;">Background Mod</th>
            <th style="padding:8px; border:1px solid #ccc;">Boost Mod</th>
            <th style="padding:8px; border:1px solid #ccc;">Final Value</th>
          </tr>
        </thead>
        <tbody id="stat-table"></tbody>
      </table>
      <button type="button" onclick="resetCharacter()" style="margin-top:10px;">Reset All</button>
    </div>
  </div>

  <!-- ==============
       Backstory
  =============== -->
  <div style="margin-bottom:20px;">
    <label for="backstory" style="display:block; margin-top:10px;">Backstory:</label>
    <textarea name="backstory" id="backstory" rows="4" style="width:100%; padding:8px;"></textarea>
  </div>

  <div style="text-align:center;">
    <button type="submit" style="padding:10px 20px; font-size:16px;">
      Finish Stage 1 &amp; Create Character
    </button>
  </div>
</form>

<script>

let racialASIBonus = {
    "Strength": 0,
    "Dexterity": 0,
    "Constitution": 0,
    "Intelligence": 0,
    "Wisdom": 0,
    "Charisma": 0
  };
  let racialASIPoints = 0; // points available for customizable races

  // Fixed racial modifiers for each race/subrace.
  const racialModifiersDict = {
    "human":         { "Strength": 0, "Dexterity": 0, "Constitution": 0, "Intelligence": 0, "Wisdom": 0, "Charisma": 0 },
    "rodanin":       { "Strength": 0, "Dexterity": 0, "Constitution": 0, "Intelligence": 0, "Wisdom": 0, "Charisma": 0 },
    "naskrimni":     { "Strength": 0, "Dexterity": 0, "Constitution": 0, "Intelligence": 0, "Wisdom": 0, "Charisma": 0 },
    "turami":        { "Strength": 0, "Dexterity": 0, "Constitution": 0, "Intelligence": 0, "Wisdom": 0, "Charisma": 0 },
    "ithiskar":      { "Strength": 0, "Dexterity": 0, "Constitution": 0, "Intelligence": 0, "Wisdom": 0, "Charisma": 0 },
    "cadmir":        { "Strength": 0, "Dexterity": 0, "Constitution": 0, "Intelligence": 0, "Wisdom": 0, "Charisma": 0 },
    "illuskan":      { "Strength": 0, "Dexterity": 0, "Constitution": 0, "Intelligence": 0, "Wisdom": 0, "Charisma": 0 },
    "shurinese":     { "Strength": 0, "Dexterity": 0, "Constitution": 0, "Intelligence": 0, "Wisdom": 0, "Charisma": 0 },
    "ferro":         { "Strength": 0, "Dexterity": 0, "Constitution": 0, "Intelligence": 0, "Wisdom": 0, "Charisma": 0 },
    "unaligned":     { "Strength": 0, "Dexterity": 0, "Constitution": 0, "Intelligence": 0, "Wisdom": 0, "Charisma": 0 },
    "hill_dwarf":    { "Strength": 1, "Dexterity": 0, "Constitution": 3, "Intelligence": 0, "Wisdom": 1, "Charisma": 0 },
    "mountain_dwarf":{ "Strength": 2, "Dexterity": -1, "Constitution": 3, "Intelligence": 0, "Wisdom": 0, "Charisma": 0 },
    "dwarf":         { "Strength": 0, "Dexterity": 0, "Constitution": 3, "Intelligence": 0, "Wisdom": 0, "Charisma": 0 },
    "high_elf":      { "Strength": 0, "Dexterity": 3, "Constitution": -1, "Intelligence": 2, "Wisdom": 0, "Charisma": 0 },
    "wood_elf":      { "Strength": 0, "Dexterity": 3, "Constitution": -1, "Intelligence": 0, "Wisdom": 2, "Charisma": 0 },
    "drow":          { "Strength": 0, "Dexterity": 3, "Constitution": -1, "Intelligence": 0, "Wisdom": 0, "Charisma": 2 },
    "elf":           { "Strength": 0, "Dexterity": 3, "Constitution": -1, "Intelligence": 0, "Wisdom": 0, "Charisma": 0 },
    "rock_gnome":    { "Strength": 0, "Dexterity": 0, "Constitution": 1, "Intelligence": 2, "Wisdom": 0, "Charisma": 0 },
    "stone_gnome":   { "Strength": 0, "Dexterity": 0, "Constitution": 1, "Intelligence": 2, "Wisdom": 0, "Charisma": 1 },
    "gnome":         { "Strength": 0, "Dexterity": 0, "Constitution": 1, "Intelligence": 2, "Wisdom": 0, "Charisma": 0 },
    "tiefling":      { "Strength": 0, "Dexterity": 1, "Constitution": 0, "Intelligence": 1, "Wisdom": 0, "Charisma": 2 },
    "lizardfolk":    { "Strength": 1, "Dexterity": 1, "Constitution": 2, "Intelligence": 0, "Wisdom": 1, "Charisma": -1 },
    "halfling":      { "Strength": 0, "Dexterity": 2, "Constitution": 0, "Intelligence": 0, "Wisdom": 0, "Charisma": 2 },
    "half_orc":      { "Strength": 1, "Dexterity": 0, "Constitution": 2, "Intelligence": 0, "Wisdom": 0, "Charisma": 0 },
    "tabaxi":        { "Strength": 0, "Dexterity": 2, "Constitution": 0, "Intelligence": 1, "Wisdom": 0, "Charisma": 1 },
    "goliath":       { "Strength": 3, "Dexterity": 0, "Constitution": 2, "Intelligence": -1, "Wisdom": 0, "Charisma": 0 },
    "goblin":        { "Strength": 1, "Dexterity": 3, "Constitution": 2, "Intelligence": 0, "Wisdom": 0, "Charisma": -2 },
    "githyanki":     { "Strength": 1, "Dexterity": 1, "Constitution": 0, "Intelligence": 2, "Wisdom": 0, "Charisma": 0 },
    "warforged":     { "Strength": 2, "Dexterity": 0, "Constitution": 2, "Intelligence": 1, "Wisdom": 0, "Charisma": -1 },
    "elf_nymph":     { "Strength": -2, "Dexterity": 2, "Constitution": -2, "Intelligence": 0, "Wisdom": 2, "Charisma": 2 },
    "yuan_ti":       { "Strength": 0, "Dexterity": 0, "Constitution": 2, "Intelligence": 1, "Wisdom": 0, "Charisma": 1 },
    "kitsune":       { "Strength": 0, "Dexterity": 1, "Constitution": 0, "Intelligence": 1, "Wisdom": 0, "Charisma": 2 },
    "half_elf":      { "Strength": 0, "Dexterity": 1, "Constitution": 0, "Intelligence": 0, "Wisdom": 0, "Charisma": 1 },
    // Half-Elf subrace options:
    "half_elf_elf_dominated":   { "Strength": 0, "Dexterity": 1, "Constitution": 0, "Intelligence": 1, "Wisdom": 0, "Charisma": 0 },
    "half_elf_wood_elf":        { "Strength": 0, "Dexterity": 1, "Constitution": 0, "Intelligence": 0, "Wisdom": 1, "Charisma": 0 },
    "half_elf_dark_elf":        { "Strength": 0, "Dexterity": 1, "Constitution": 0, "Intelligence": 0, "Wisdom": 0, "Charisma": 1 },
    // For customizable bonus half-elves:
    "half_elf_human_dominated": { "Strength": 0, "Dexterity": 0, "Constitution": 0, "Intelligence": 0, "Wisdom": 0, "Charisma": 0 },
    "half_elf_fully":           { "Strength": 0, "Dexterity": 0, "Constitution": 0, "Intelligence": 0, "Wisdom": 0, "Charisma": 0 }
  };

  // Background "database" with skill proficiency data.


  // Subrace options dictionary.
  const subracesDict = {
    "human": [
      { value: "rodanin", label: "Rodanin" },
      { value: "naskrimni", label: "Naskrimni" },
      { value: "turami", label: "Turami" },
      { value: "ithiskar", label: "Ithiskar" },
      { value: "cadmir", label: "Cadmir" },
      { value: "illuskan", label: "Illuskan" },
      { value: "shurinese", label: "Shurinese" },
      { value: "ferro", label: "Ferro" },
      { value: "unaligned", label: "Unaligned" }
    ],
    dwarf: [
      { value: "hill_dwarf", label: "Hill Dwarf" },
      { value: "mountain_dwarf", label: "Mountain Dwarf" }
    ],
    elf: [
      { value: "high_elf", label: "High Elf" },
      { value: "wood_elf", label: "Wood Elf" },
      { value: "drow", label: "Drow (Dark Elf)" }
    ],
    gnome: [
      { value: "rock_gnome", label: "Rock Gnome" },
      { value: "stone_gnome", label: "Stone Gnome" }
    ],
    half_elf: [
      { value: "half_elf_elf_dominated", label: "Elf-Dominated (High Elf: +1 Int, +1 Dex)" },
      { value: "half_elf_wood_elf", label: "Elf-Dominated (Wood Elf: +1 Wis, +1 Dex)" },
      { value: "half_elf_dark_elf", label: "Elf-Dominated (Dark Elf: +1 Cha, +1 Dex)" },
      { value: "half_elf_human_dominated", label: "Human-Dominated (+1 to any 2 abilities)" },
      { value: "half_elf_fully", label: "Fully Half-Blooded (Choose origin below)" }
    ]
  };

  // Define customizable races (races that let you allocate extra racial bonus points)
  const customizableRaces = {
    "human": 4,
    "rodanin": 4,
    "naskrimni": 4,
    "turami": 4,
    "ithiskar": 4,
    "cadmir": 4,
    "illuskan": 4,
    "shurinese": 4,
    "ferro": 4,
    "unaligned": 4,
    "half_elf_human_dominated": 2,
    "half_orc": 1,
    "half_elf_fully": 1
  };

    const backgrounds = {
    noble: {
  main: { primary: { ability: "Charisma", bonus: 2, skill: "Persuasion" }, secondary: { ability: "Intelligence", bonus: 1, skill: "History" } },
  side: { primary: { ability: "Charisma", bonus: 2, skill: "Persuasion" } }
},
    commoner: {
      main: {
        primary: { ability: "Constitution", bonus: 2, skill: "Survival" },
        secondary: { ability: "Strength", bonus: 1, skill: "Athletics" }
      },
      side: {
        primary: { ability: "Constitution", bonus: 2, skill: "Survival" }
      }
    },
    artisan: {
      main: {
        primary: { ability: "Dexterity", bonus: 2, skill: "Sleight of Hand" },
        secondary: { ability: "Wisdom", bonus: 1, skill: "Perception" }
      },
      side: {
        primary: { ability: "Dexterity", bonus: 2, skill: "Sleight of Hand" }
      }
    }
    // Add more backgrounds as needed...
  };
  
  let currentRacialModifiers = {};

  document.addEventListener("DOMContentLoaded", function() {
    // Update Race dropdown
// Race dropdown text update
const raceDropdown = document.getElementById("race");
for (let i = 0; i < raceDropdown.options.length; i++) {
  let option = raceDropdown.options[i];
  if (!option.value) continue; // skip placeholder
  // If we now have a 'half_elf' entry, it won't be blank
  if (racialModifiersDict[option.value]) {
    const mods = racialModifiersDict[option.value];
    option.text = `${option.text} (Str: ${mods.Strength}, Dex: ${mods.Dexterity}, Con: ${mods.Constitution}, Int: ${mods.Intelligence}, Wis: ${mods.Wisdom}, Cha: ${mods.Charisma})`;
  }
}


    // Update Main Background dropdown
    const mainBgDropdown = document.getElementById("main_background");
    for (let i = 0; i < mainBgDropdown.options.length; i++) {
      let option = mainBgDropdown.options[i];
      if (option.value && backgrounds[option.value]) {
        let bg = backgrounds[option.value].main;
        option.text = `${option.text} (+${bg.primary.bonus} ${bg.primary.ability}, +${bg.secondary.bonus} ${bg.secondary.ability} / Skills: ${bg.primary.skill}, ${bg.secondary.skill})`;
      }
    }

    // Update Side Background dropdowns
    const sideBgDropdowns = [
      document.getElementById("side_background_1"),
      document.getElementById("side_background_2")
    ];
    sideBgDropdowns.forEach(dropdown => {
      for (let i = 0; i < dropdown.options.length; i++) {
        let option = dropdown.options[i];
        if (option.value && backgrounds[option.value]) {
          // We assume side backgrounds use the "side" data structure.
          let bgSide = backgrounds[option.value].side;
          option.text = `${option.text} (+${bgSide.primary.bonus} ${bgSide.primary.ability} / Skill: ${bgSide.primary.skill})`;
        }
      }
    });

    
    document.getElementById("main_background").addEventListener("change", function() {
  const side1Value = document.getElementById("side_background_1").value;
  const side2Value = document.getElementById("side_background_2").value;
  if (this.value === side1Value && this.value !== "") {
    alert("Main Background cannot be the same as Side Background 1.");
    this.value = "";
  } else if (this.value === side2Value && this.value !== "") {
    alert("Main Background cannot be the same as Side Background 2.");
    this.value = "";
  }
  updateBackgroundSkillProficiencies();
  updateDisplay();
});
  // Global state variables
  const stats = ["Strength", "Dexterity", "Constitution", "Intelligence", "Wisdom", "Charisma"];
  let baseStats = {}, raceModifiers = {}, backgroundModifiers = {}, boostModifiers = {};
  let pointsRemaining = 12, boostsRemaining = 5;
  let boostedStats = {};
  let step = 1; // 1 = Point Buy, 2 = Race, 3 = Background, 4 = Boosts
  let highBoostedUsed = false;
  let asiApplied = 0;
  
  // For customizable racial ASI bonuses

  // Helper: Get number of side backgrounds chosen from radio.
  function getSideCount() {
    const chosenCombo = document.querySelector('input[name="bg_combo"]:checked').value;
    return parseInt(chosenCombo, 10);
  }

  // Update background skill proficiencies display.
  function updateBackgroundSkillProficiencies() {
    let skillProficiencies = {};
    
    function addSkill(skill) {
      if (!skill) return;
      skillProficiencies[skill] = (skillProficiencies[skill] || 0) + 1;
    }
    
    const sideCount = getSideCount();
    if (sideCount === 1) {
      const side1Key = document.getElementById("side_background_1").value;
      const side1BonusType = document.querySelector('input[name="side1_bonus_type"]:checked').value;
      if (side1Key && backgrounds[side1Key] && side1BonusType === "skill") {
        addSkill(backgrounds[side1Key].side.primary.skill);
      }
    } else if (sideCount === 2) {
      const side1Key = document.getElementById("side_background_1").value;
      const side2Key = document.getElementById("side_background_2").value;
      const side1BonusType = document.querySelector('input[name="side1_bonus_type"]:checked').value;
      const side2BonusType = document.querySelector('input[name="side2_bonus_type"]:checked').value;
      
      if (side1Key && backgrounds[side1Key] && side1BonusType === "skill") {
        addSkill(backgrounds[side1Key].side.primary.skill);
      }
      if (side2Key && backgrounds[side2Key] && side2BonusType === "skill" && side2Key !== side1Key) {
        addSkill(backgrounds[side2Key].side.primary.skill);
      }
    }
    
    // Cap each skill at 2.
    for (let skill in skillProficiencies) {
      if (skillProficiencies[skill] > 2) {
        skillProficiencies[skill] = 2;
      }
    }
    
    let displayText = "";
    for (let skill in skillProficiencies) {
      displayText += `<strong>${skill}</strong>: ${skillProficiencies[skill]}<br>`;
    }
    if (displayText === "") {
      displayText = "No skill proficiencies allocated yet.";
    }
    document.getElementById("background-skill-display").innerHTML = displayText;
  }

  // Event listeners for radio buttons that determine background combination
  document.querySelectorAll('input[name="bg_combo"]').forEach(rb => {
    rb.addEventListener('change', () => {
      const comboValue = parseInt(rb.value, 10);
      // Hide both side background containers by default
      document.getElementById("side_background_1_container").style.display = "none";
      document.getElementById("side_background_2_container").style.display = "none";

      if (comboValue === 1) {
        document.getElementById("side_background_1_container").style.display = "block";
        document.getElementById("side_background_2").value = "";
      } else if (comboValue === 2) {
        document.getElementById("side_background_1_container").style.display = "block";
        document.getElementById("side_background_2_container").style.display = "block";
      } else {
        document.getElementById("side_background_1").value = "";
        document.getElementById("side_background_2").value = "";
      }
      updateBackgroundSkillProficiencies();
      updateDisplay();
    });
  });

  // Duplicate check for side backgrounds
  document.getElementById("side_background_1").addEventListener("change", function() {
    const mainValue = document.getElementById("main_background").value;
if (this.value === mainValue && this.value !== "") {
  alert("Side Background 1 cannot be the same as Main Background.");
  this.value = "";
  updateBackgroundSkillProficiencies();
  updateDisplay();
  return;
}
// existing check for side_background_2 duplication...

    const side2Value = document.getElementById("side_background_2").value;
    if (this.value === side2Value && this.value !== "") {
      alert("Please select a different side background. You cannot choose the same background twice.");
      this.value = "";
      updateBackgroundSkillProficiencies();
      updateDisplay();
    }
  });
  document.getElementById("side_background_2").addEventListener("change", function() {
    const mainValue = document.getElementById("main_background").value;
if (this.value === mainValue && this.value !== "") {
  alert("Side Background 2 cannot be the same as Main Background.");
  this.value = "";
  updateBackgroundSkillProficiencies();
  updateDisplay();
  return;
}
// existing check for side_background_2 duplication...

    const side1Value = document.getElementById("side_background_1").value;
    if (this.value === side1Value && this.value !== "") {
      alert("Please select a different side background. You cannot choose the same background twice.");
      this.value = "";
      updateBackgroundSkillProficiencies();
      updateDisplay();
    }
  });

 
document.getElementById("race").addEventListener("change", function() {
  const selectedMainRace = this.value;
  const subraceContainer = document.getElementById("subrace-container");
  if (subracesDict[selectedMainRace]) {
    subraceContainer.style.display = "block";
    const subraceSelect = document.getElementById("subrace");
    subraceSelect.innerHTML = "";
    // (Optionally add a blank option here if you want the user to choose a subrace)
    subracesDict[selectedMainRace].forEach(option => {
      let opt = document.createElement("option");
      opt.value = option.value;
      opt.text = option.label;
      subraceSelect.appendChild(opt);
    });
    // Leave it with no subrace selected so that getCurrentRacialModifiers() returns the default bonus.
    subraceSelect.value = "";
  } else {
    subraceContainer.style.display = "none";
  }
  // (Other update calls)
  updateHalfElfOriginDisplay();
  checkForCustomizable();
  updateDisplay();
});



  // Subrace change listener.
  document.getElementById("subrace").addEventListener("change", function() {
    const selectedSubrace = this.value;
    currentRacialModifiers = racialModifiersDict[selectedSubrace] || { "Strength": 0, "Dexterity": 0, "Constitution": 0, "Intelligence": 0, "Wisdom": 0, "Charisma": 0 };
    updateHalfElfOriginDisplay();
    checkForCustomizable();
    updateDisplay();
  });

  // Half-elf origin listener.
  document.getElementById("half-elf-origin").addEventListener("change", function() {
    updateDisplay();
  });

  // Function to update the half-elf origin container display.
  function updateHalfElfOriginDisplay() {
    let raceValue = (document.getElementById("subrace-container").style.display !== "none") ?
                     document.getElementById("subrace").value : document.getElementById("race").value;
    if (raceValue === "half_elf_fully") {
      document.getElementById("half-elf-origin-container").style.display = "block";
    } else {
      document.getElementById("half-elf-origin-container").style.display = "none";
    }
  }

  // Check for customizable racial bonus allocation.
  function checkForCustomizable() {
    let raceValue = (document.getElementById("subrace-container").style.display !== "none") ?
                     document.getElementById("subrace").value : document.getElementById("race").value;
    if (raceValue === "half_elf_fully") {
      racialASIPoints = customizableRaces[raceValue];
      document.getElementById("racial-allocation-section").style.display = "block";
      document.getElementById("racial-points").innerText = racialASIPoints;
    } else if (customizableRaces.hasOwnProperty(raceValue)) {
      document.getElementById("racial-allocation-section").style.display = "block";
      document.getElementById("racial-points").innerText = customizableRaces[raceValue];
    } else {
      document.getElementById("racial-allocation-section").style.display = "none";
      currentRacialModifiers = racialModifiersDict[raceValue] || { "Strength": 0, "Dexterity": 0, "Constitution": 0, "Intelligence": 0, "Wisdom": 0, "Charisma": 0 };
    }
  }

  // Function to apply customizable racial allocation.
  function applyRacialAllocation() {
    const inputs = ["racial-strength", "racial-dexterity", "racial-constitution", "racial-intelligence", "racial-wisdom", "racial-charisma"];
    let total = 0;
    for (let id of inputs) {
      let val = Number(document.getElementById(id).value);
      if (val > 1) {
        alert("Each ability can receive a maximum of +1.");
        return;
      }
      total += val;
    }
    let raceValue = (document.getElementById("subrace-container").style.display !== "none") ?
                    document.getElementById("subrace").value : document.getElementById("race").value;
    const allowed = customizableRaces[raceValue];
    if (total !== allowed) {
      alert("Please allocate exactly " + allowed + " bonus point(s).");
      return;
    }
    racialASIBonus["Strength"] = Number(document.getElementById("racial-strength").value);
    racialASIBonus["Dexterity"] = Number(document.getElementById("racial-dexterity").value);
    racialASIBonus["Constitution"] = Number(document.getElementById("racial-constitution").value);
    racialASIBonus["Intelligence"] = Number(document.getElementById("racial-intelligence").value);
    racialASIBonus["Wisdom"] = Number(document.getElementById("racial-wisdom").value);
    racialASIBonus["Charisma"] = Number(document.getElementById("racial-charisma").value);
    updateDisplay();
    alert("Racial bonuses applied!");
  }

  // Final race value setter before submission.
  document.getElementById("characterForm").addEventListener("submit", function() {
    let finalRaceValue = (document.getElementById("subrace-container").style.display !== "none") ?
                         document.getElementById("subrace").value : document.getElementById("race").value;
    document.getElementById("finalRace").value = finalRaceValue;
  });

  // Functions to adjust stats.
  function adjustStat(stat, amount) {
    if (step !== 1) return;
    if (amount === 1 && pointsRemaining > 0 && baseStats[stat] < 13) {
      baseStats[stat]++;
      pointsRemaining--;
    } else if (amount === -1 && baseStats[stat] > 8) {
      baseStats[stat]--;
      pointsRemaining++;
    }
    updateDisplay();
  }



  function applyBoost(stat, value) {
    if (step < 4 || boostedStats[stat]) return;
    if (boostsRemaining <= 0) return;
    let currentScore = baseStats[stat] + (getCurrentRacialModifiers()[stat] || 0) + (backgroundModifiers[stat] || 0);
    if (value === 2 && currentScore >= 14 && currentScore <= 17) {
      if (highBoostedUsed) return;
      if (boostsRemaining >= 2) {
        boostModifiers[stat] += 2;
        boostsRemaining -= 2;
        highBoostedUsed = true;
      } else return;
    } else if (value === 1 && currentScore >= 14) {
      if (currentScore + 1 > 19) return;
      boostModifiers[stat] += 1;
      boostsRemaining--;
    } else if (value === 2 && currentScore <= 13) {
      boostModifiers[stat] += 2;
      boostsRemaining--;
    } else if (value === 3 && currentScore <= 10) {
      boostModifiers[stat] += 3;
      boostsRemaining--;
    } else {
      return;
    }
    boostedStats[stat] = true;
    updateDisplay();
  }

  function resetRace() {
    stats.forEach(stat => { raceModifiers[stat] = 0; });
    step = Math.max(step, 2);
    updateDisplay();
  }

  function resetBackground() {
    stats.forEach(stat => { backgroundModifiers[stat] = 0; });
    step = Math.max(step, 3);
    updateDisplay();
  }

  function resetBoosts() {
    stats.forEach(stat => { boostModifiers[stat] = 0; });
    boostedStats = {};
    boostsRemaining = 5;
    highBoostedUsed = false;
    step = Math.max(step, 4);
    updateDisplay();
  }


  // Update background modifiers based on main and side backgrounds.
  function updateBackgroundModifiers() {
    let bgModifiers = { "Strength": 0, "Dexterity": 0, "Constitution": 0, "Intelligence": 0, "Wisdom": 0, "Charisma": 0 };
    let bgCount = { "Strength": 0, "Dexterity": 0, "Constitution": 0, "Intelligence": 0, "Wisdom": 0, "Charisma": 0 };
    const mainBGKey = document.getElementById("main_background").value;
    if (mainBGKey && backgrounds[mainBGKey]) {
      const mainBG = backgrounds[mainBGKey].main;
      let primAbility = mainBG.primary.ability;
      bgModifiers[primAbility] += mainBG.primary.bonus;
      bgCount[primAbility]++;
      let secAbility = mainBG.secondary.ability;
      bgModifiers[secAbility] += mainBG.secondary.bonus;
      bgCount[secAbility]++;
    }
    const sideCount = getSideCount();
    if (sideCount === 1) {
  const side1Key = document.getElementById("side_background_1").value;
  const side1BonusType = document.querySelector('input[name="side1_bonus_type"]:checked').value;
  if (side1Key && backgrounds[side1Key] && side1BonusType === "ability") {
    // For side backgrounds, the bonus is always +1 (regardless of what the primary bonus normally is)
    let bonus = 1;
    let ability = backgrounds[side1Key].side.primary.ability;
    if (bgCount[ability] < 2) {
      bgModifiers[ability] += bonus;
      bgCount[ability]++;
    }
  }
}
  


if (sideCount === 2) {
  const side1Key = document.getElementById("side_background_1").value;
  const side2Key = document.getElementById("side_background_2").value;
  const side1BonusType = document.querySelector('input[name="side1_bonus_type"]:checked').value;
  const side2BonusType = document.querySelector('input[name="side2_bonus_type"]:checked').value;
  
  if (side1Key && backgrounds[side1Key] && side1BonusType === "ability") {
    let bonus = 1;
    let ability = backgrounds[side1Key].side.primary.ability;
    if (bgCount[ability] < 2) {
      bgModifiers[ability] += bonus;
      bgCount[ability]++;
    }
  }
  if (side2Key && backgrounds[side2Key] && side2BonusType === "ability") {
    let bonus = 1;
    let ability = backgrounds[side2Key].side.primary.ability;
    if (bgCount[ability] < 2) {
      bgModifiers[ability] += bonus;
      bgCount[ability]++;
    }
  }
}
backgroundModifiers = bgModifiers;


  }

  // Update display function: update table and hidden inputs.
  function updateDisplay() {
    updateBackgroundModifiers();
    let effectiveModifiers = getCurrentRacialModifiers();
    document.getElementById("points-remaining").innerText = pointsRemaining;
    document.getElementById("boosts-remaining").innerText = boostsRemaining;
      document.getElementById("background-total").innerText = Object.values(backgroundModifiers).reduce((a, b) => a + b, 0);
    
    if (step === 1 && pointsRemaining === 0) step = 2;
    if (step === 2 && Object.values(effectiveModifiers).reduce((a, b) => a + b, 0) >= 4) step = 3;
    if (step === 3 && Object.values(backgroundModifiers).reduce((a, b) => a + b, 0) >= 3) step = 4;
    
    let tableContent = "";
    stats.forEach(stat => {
      let base = baseStats[stat];
      let fixedRace = effectiveModifiers[stat] || 0;
      let bgMod = backgroundModifiers[stat] || 0;
      let boostMod = boostModifiers[stat] || 0;
      let finalValue = base + fixedRace + bgMod + boostMod;
      tableContent += `
        <tr>
          <td style="padding:8px; border:1px solid #ccc;">${stat}</td>
          <td style="padding:8px; border:1px solid #ccc;">
            <button type="button" onclick="adjustStat('${stat}', 1)" ${step !== 1 ? 'disabled' : ''}>+</button>
            ${base}
            <button type="button" onclick="adjustStat('${stat}', -1)" ${step !== 1 || base <= 8 ? 'disabled' : ''}>-</button>
          </td>
          <td style="padding:8px; border:1px solid #ccc;">${fixedRace}</td>
          <td style="padding:8px; border:1px solid #ccc;">
            <button type="button" onclick="adjustBackground('${stat}', 1)" ${step < 3 ? 'disabled' : ''}>+1</button>
            <button type="button" onclick="adjustBackground('${stat}', 2)" ${step < 3 ? 'disabled' : ''}>+2</button>
            ${bgMod}
          </td>
          <td style="padding:8px; border:1px solid #ccc;">
            <button type="button" onclick="applyBoost('${stat}', 3)" ${step < 4 || boostedStats[stat] ? 'disabled' : ''}>+3</button>
            <button type="button" onclick="applyBoost('${stat}', 2)" ${step < 4 || boostedStats[stat] ? 'disabled' : ''}>+2</button>
            <button type="button" onclick="applyBoost('${stat}', 1)" ${step < 4 || boostedStats[stat] ? 'disabled' : ''}>+1</button>
            ${boostMod}
          </td>
          <td style="padding:8px; border:1px solid #ccc;">${finalValue}</td>
        </tr>
      `;
    });
    document.getElementById("stat-table").innerHTML = tableContent;
    
    // Update hidden inputs for final ability scores.
    document.getElementById("strengthInput").value = baseStats["Strength"] + (effectiveModifiers["Strength"] || 0) + (backgroundModifiers["Strength"] || 0);
    document.getElementById("dexterityInput").value = baseStats["Dexterity"] + (effectiveModifiers["Dexterity"] || 0) + (backgroundModifiers["Dexterity"] || 0);
    document.getElementById("constitutionInput").value = baseStats["Constitution"] + (effectiveModifiers["Constitution"] || 0) + (backgroundModifiers["Constitution"] || 0);
    document.getElementById("intelligenceInput").value = baseStats["Intelligence"] + (effectiveModifiers["Intelligence"] || 0) + (backgroundModifiers["Intelligence"] || 0);
    document.getElementById("wisdomInput").value = baseStats["Wisdom"] + (effectiveModifiers["Wisdom"] || 0) + (backgroundModifiers["Wisdom"] || 0);
    document.getElementById("charismaInput").value = baseStats["Charisma"] + (effectiveModifiers["Charisma"] || 0) + (backgroundModifiers["Charisma"] || 0);
    
    // Update racial allocation display if visible.
    const racialContainer = document.getElementById("racial-allocation-section");
    if (racialContainer && racialContainer.style.display !== "none") {
      document.getElementById("racial-points").innerText = racialASIPoints;
    }
  }

  // Function to get current effective racial modifiers (including customizable bonus if half-elf fully)
  function getCurrentRacialModifiers() {
  const mainRace = document.getElementById("race").value;
  
  // If the main race is Half-Elf, always include the default bonus.
  if (mainRace === "half_elf") {
    const defaultBonus = racialModifiersDict["half_elf"] || { "Strength": 0, "Dexterity": 1, "Constitution": 0, "Intelligence": 0, "Wisdom": 0, "Charisma": 1 };
    const subraceContainer = document.getElementById("subrace-container");
    // If the subrace dropdown is visible, try to read its value.
    if (subraceContainer.style.display !== "none") {
      const subVal = document.getElementById("subrace").value;
      if (subVal) {
        const subBonus = racialModifiersDict[subVal] || { "Strength": 0, "Dexterity": 0, "Constitution": 0, "Intelligence": 0, "Wisdom": 0, "Charisma": 0 };
        return {
          "Strength": defaultBonus.Strength + subBonus.Strength,
          "Dexterity": defaultBonus.Dexterity + subBonus.Dexterity,
          "Constitution": defaultBonus.Constitution + subBonus.Constitution,
          "Intelligence": defaultBonus.Intelligence + subBonus.Intelligence,
          "Wisdom": defaultBonus.Wisdom + subBonus.Wisdom,
          "Charisma": defaultBonus.Charisma + subBonus.Charisma
        };
      }
    }
    // If no subrace is chosen, return the default bonus.
    return defaultBonus;
  }
  
  // For all other races, use the value from your dictionary or currentRacialModifiers.
  return racialModifiersDict[mainRace] || currentRacialModifiers;
}






  // Functions to adjust base stats (Point Buy)


  function adjustBackground(stat, value) {
    if (step < 3) return;
    let newTotal = Object.values(backgroundModifiers).reduce((a, b) => a + b, 0) + value - (backgroundModifiers[stat] || 0);
    if (newTotal > 3) return;
    backgroundModifiers[stat] = value;
    updateDisplay();
  }




 
  function resetCharacter() {
    initializeCharacter();
  }

  // Initialize character with base values.
  function initializeCharacter() {
    stats.forEach(stat => {
      baseStats[stat] = 8;
      raceModifiers[stat] = 0;
      backgroundModifiers[stat] = 0;
      boostModifiers[stat] = 0;
      boostedStats[stat] = false;
    });
    pointsRemaining = 12;
    boostsRemaining = 5;
    step = 1;
    highBoostedUsed = false;
    asiApplied = 0;
    updateDisplay();
  }

  // Finally, call initializeCharacter on load.
  initializeCharacter();



});


</script>



{% endblock %}
